{% extends 'base.html' %}
{% load static %}
{% load win_filters %}

{% block title %}My Daily Wins - Week of {{ week_label }}{% endblock %}

{% block content %}
<!-- Custom week dashboard styles -->
<style>
    /* Prevent conflicts with base template */
    .week-container,
    .week-container * {
        box-sizing: border-box;
    }
    
    /* Override base card styles for day cards */
    .week-container .card {
        box-shadow: none !important;
        border: none !important;
        margin-bottom: 0 !important;
    }
</style>

<div class="week-container">
    <!-- Week Header with Rainbow Border -->
    <div style="
        position: relative;
        margin-bottom: 40px;
        padding: 6px;
        background: linear-gradient(90deg, #ff6b6b, #ffa726, #66bb6a, #42a5f5, #ab47bc);
        background-size: 300% 100%;
        animation: gradient-shift 3s ease infinite;
        border-radius: 26px;
    ">
        <div style="
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 20px;
            position: relative;
        ">
            <h1 style="font-size: 1.8rem; font-weight: bold; margin-bottom: 5px;">‚ú® My Daily Wins ‚ú®</h1>
            <p style="font-size: 1rem; opacity: 0.9; margin-bottom: 15px;">Week of {{ week_label }}</p>
            
            <!-- Improved three-column layout: Weekly Stats, Sticky Notes, Monthly Calendar -->
            <div style="display: grid; grid-template-columns: 0.8fr 1.5fr 1fr; gap: 25px; align-items: start;">
                
                <!-- Left: Weekly Stats (improved clarity) -->
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <h3 style="font-size: 0.85rem; margin-bottom: 5px; opacity: 0.9; text-align: center;">üìä THIS WEEK</h3>
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);">
                        <div style="font-size: 2rem; font-weight: bold; line-height: 1; margin-bottom: 4px;">{{ week_stats.entries_count }}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9; font-weight: 500;">DAILY WINS</div>
                        <div style="font-size: 0.65rem; opacity: 0.7; margin-top: 2px;">LOGGED</div>
                    </div>
                    {% if week_stats.avg_mood %}
                    <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 12px; text-align: center; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.3);">
                        <div style="font-size: 2rem; font-weight: bold; line-height: 1; margin-bottom: 4px;">{{ week_stats.avg_mood }}</div>
                        <div style="font-size: 0.75rem; opacity: 0.9; font-weight: 500;">AVG MOOD</div>
                        <div style="font-size: 0.65rem; opacity: 0.7; margin-top: 2px;">THIS WEEK</div>
                    </div>
                    {% endif %}
                </div>
                
                <!-- Center: Sticky Notes -->
                <div style="text-align: center;">
                    <h3 style="font-size: 0.9rem; margin-bottom: 15px; opacity: 0.9;">üìù Quick Notes</h3>
                    <div id="sticky-notes-container" style="display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; min-height: 120px;">
                        {% for note in sticky_notes %}
                        <div class="sticky-note" data-note-id="{{ note.id }}">
                            <div class="sticky-note-content" contenteditable="true" data-placeholder="Quick note...">{{ note.content }}</div>
                            <div class="sticky-note-actions">
                                <button class="complete-btn" title="Complete as win" onclick="completeNote({{ note.id }})">‚úì</button>
                                <button class="delete-btn" title="Delete note" onclick="deleteNote({{ note.id }})">√ó</button>
                            </div>
                        </div>
                        {% empty %}
                        <div class="sticky-note" data-note-id="new">
                            <div class="sticky-note-content" contenteditable="true" data-placeholder="Click to add a quick note..." onclick="createFirstNote(this)"></div>
                        </div>
                        {% endfor %}
                        
                        {% if sticky_notes %}
                        <button id="add-note-btn" class="add-note-button" onclick="addNewNote()" title="Add another note">+</button>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Right: Monthly Calendar (moved higher, more prominent) -->
                <div style="text-align: center;">
                    <!-- Compact calendar header with navigation -->
                    <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 12px;">
                        <button onclick="changeMonth(-1)" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-right: 12px; font-size: 1.1rem; font-weight: bold; transition: all 0.2s;">‚Äπ</button>
                        <h3 id="calendar-month" style="font-size: 0.9rem; opacity: 0.95; margin: 0; min-width: 100px; font-weight: 600;">{{ month_name|upper }}</h3>
                        <button onclick="changeMonth(1)" style="background: rgba(255,255,255,0.3); border: none; color: white; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-left: 12px; font-size: 1.1rem; font-weight: bold; transition: all 0.2s;">‚Ä∫</button>
                    </div>
                    
                    <div style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; backdrop-filter: blur(10px);">
                        <!-- Compact calendar header -->
                        <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 5px;">
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">M</div>
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">T</div>
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">W</div>
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">T</div>
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">F</div>
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">S</div>
                            <div style="font-size: 0.6rem; font-weight: bold; opacity: 0.7; padding: 2px;">S</div>
                        </div>
                        
                        <!-- Compact calendar days -->
                        <div id="calendar-grid">
                            {% for week in calendar_weeks %}
                            <div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; margin-bottom: 2px;">
                                {% for day in week %}
                                <div class="calendar-day-compact
                                    {% if day.is_today %}calendar-today-compact{% endif %}
                                    {% if day.has_entry %}calendar-has-entry-compact{% endif %}
                                    {% if not day.day %}calendar-empty-compact{% endif %}" 
                                    data-day="{{ day.day }}"
                                    {% if day.has_entry and day.day %}
                                    onclick="showDayEntry('{{ day.date|date:'Y-m-d' }}')"
                                    {% endif %}>
                                    {% if day.day %}{{ day.day }}{% endif %}
                                    {% if day.has_entry %}<span class="entry-dot-compact">‚óè</span>{% endif %}
                                </div>
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                        
                        <div style="margin-top: 6px; font-size: 0.55rem; opacity: 0.7;">
                            <span style="color: #66bb6a;">‚óè</span> Click entries
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Compact calendar and sticky notes styles -->
            <style>
                /* Sticky Note Styles */
                .sticky-note {
                    width: 110px;
                    height: 110px;
                    background: #ffeb3b;
                    background: linear-gradient(135deg, #fff59d 0%, #ffeb3b 100%);
                    box-shadow: 0 4px 8px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
                    border-radius: 2px;
                    position: relative;
                    transform: rotate(-2deg);
                    transition: all 0.3s ease;
                    cursor: pointer;
                    border: 1px solid rgba(0,0,0,0.1);
                }
                
                .sticky-note:nth-child(even) {
                    transform: rotate(1deg);
                }
                
                .sticky-note:hover {
                    transform: rotate(0deg) scale(1.05);
                    box-shadow: 0 6px 12px rgba(0,0,0,0.3);
                    z-index: 10;
                }
                
                .sticky-note-content {
                    padding: 8px 6px;
                    font-family: 'Kalam', cursive, 'Comic Sans MS', cursive;
                    font-size: 0.85rem;
                    line-height: 1.2;
                    color: #333;
                    height: 100%;
                    border: none;
                    background: transparent;
                    resize: none;
                    outline: none;
                    overflow: hidden;
                    word-wrap: break-word;
                }
                
                .sticky-note-content:empty:before {
                    content: attr(data-placeholder);
                    color: #666;
                    opacity: 0.7;
                    font-style: italic;
                }
                
                .sticky-note-actions {
                    position: absolute;
                    top: 2px;
                    right: 2px;
                    display: none;
                    gap: 2px;
                }
                
                .sticky-note:hover .sticky-note-actions {
                    display: flex;
                }
                
                .complete-btn, .delete-btn {
                    width: 16px;
                    height: 16px;
                    border: none;
                    border-radius: 50%;
                    font-size: 0.6rem;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    transition: all 0.2s ease;
                }
                
                .complete-btn {
                    background: #4caf50;
                    color: white;
                }
                
                .complete-btn:hover {
                    background: #45a049;
                    transform: scale(1.1);
                }
                
                .delete-btn {
                    background: #f44336;
                    color: white;
                }
                
                .delete-btn:hover {
                    background: #da190b;
                    transform: scale(1.1);
                }
                
                .add-note-button {
                    width: 80px;
                    height: 80px;
                    background: rgba(255,255,255,0.2);
                    border: 2px dashed rgba(255,255,255,0.5);
                    border-radius: 8px;
                    color: white;
                    font-size: 1.5rem;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                }
                
                .add-note-button:hover {
                    background: rgba(255,255,255,0.3);
                    border-color: rgba(255,255,255,0.7);
                    transform: scale(1.05);
                }
                
                /* Calendar navigation button styles */
                .calendar-nav-btn:hover {
                    background: rgba(255,255,255,0.5) !important;
                    transform: scale(1.05);
                }
                
                /* Calendar styles */
                .calendar-day-compact {
                    padding: 2px 1px;
                    font-size: 0.65rem;
                    border-radius: 4px;
                    background: rgba(255, 255, 255, 0.05);
                    transition: all 0.2s ease;
                    position: relative;
                    min-height: 14px;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    cursor: default;
                }
                
                .calendar-day-compact:hover {
                    background: rgba(255, 255, 255, 0.15) !important;
                }
                
                /* Today gets white background with dark text */
                .calendar-today-compact {
                    background: rgba(255, 255, 255, 0.9) !important;
                    color: #333 !important;
                    font-weight: bold;
                    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.3);
                }
                
                .calendar-today-compact:hover {
                    background: rgba(255, 255, 255, 1) !important;
                    color: #333 !important;
                }
                
                .calendar-has-entry-compact {
                    background: rgba(102, 187, 106, 0.4) !important;
                    cursor: pointer !important;
                }
                
                .calendar-has-entry-compact:hover {
                    background: rgba(102, 187, 106, 0.6) !important;
                    transform: scale(1.15);
                }
                
                /* Today + has entry = white background with green dot */
                .calendar-today-compact.calendar-has-entry-compact {
                    background: rgba(255, 255, 255, 0.9) !important;
                    color: #333 !important;
                    cursor: pointer !important;
                }
                
                .calendar-today-compact.calendar-has-entry-compact:hover {
                    background: rgba(255, 255, 255, 1) !important;
                    transform: scale(1.15);
                }
                
                .calendar-empty-compact {
                    cursor: default;
                    background: transparent !important;
                    min-height: 16px;
                }
                
                .calendar-empty-compact:hover {
                    background: transparent !important;
                }
                
                .entry-dot-compact {
                    color: #66bb6a;
                    font-size: 0.4rem;
                    line-height: 0.4rem;
                    margin-top: 1px;
                }
                
                /* For today with entry, make dot darker for visibility */
                .calendar-today-compact .entry-dot-compact {
                    color: #2e7d32;
                    font-weight: bold;
                }
                
                @media (max-width: 768px) {
                    .grid-layout-compact {
                        grid-template-columns: 1fr !important;
                        gap: 8px !important;
                    }
                    
                    /* Make dashboard header more compact on mobile */
                    .dashboard-header {
                        padding: 15px !important;
                        margin-bottom: 20px !important;
                    }
                    
                    /* Reduce spacing in three-column layout */
                    [style*="grid-template-columns: 0.8fr 1.5fr 1fr"] {
                        gap: 15px !important;
                    }
                    
                    /* Make stats section more compact */
                    h3 {
                        font-size: 0.75rem !important;
                        margin-bottom: 8px !important;
                    }
                    
                    /* Reduce stats box padding */
                    [style*="padding: 15px"] {
                        padding: 10px !important;
                    }
                    
                    /* Make sticky notes smaller on mobile */
                    .sticky-note {
                        width: 85px;
                        height: 85px;
                    }
                    
                    .sticky-note-content {
                        font-size: 0.75rem;
                        padding: 6px 4px;
                    }
                    
                    /* Super compact calendar */
                    .calendar-day-compact {
                        padding: 0px 0px;
                        font-size: 0.55rem;
                        min-height: 10px;
                    }
                    
                    /* Reduce calendar container padding */
                    [style*="padding: 10px"] {
                        padding: 6px !important;
                    }
                    
                    /* Make calendar navigation smaller */
                    .calendar-nav-btn {
                        padding: 3px 6px !important;
                        font-size: 0.9rem !important;
                        margin: 0 6px !important;
                    }
                    
                    /* Compact calendar grid on mobile */
                    [style*="display: grid; grid-template-columns: repeat(7, 1fr)"] {
                        gap: 1px !important;
                        font-size: 0.5rem !important;
                    }
                    
                    /* Reduce calendar month header size */
                    #calendar-month {
                        font-size: 0.75rem !important;
                        min-width: 80px !important;
                    }
                    
                    .entry-dot-compact {
                        font-size: 0.3rem;
                    }
                }
            </style>
            
            <script>
                // Apply responsive class
                const gridElement = document.querySelector('[style*="grid-template-columns: auto 1fr auto"]');
                if (gridElement) {
                    gridElement.classList.add('grid-layout-compact');
                }
                
                let currentMonth = parseInt('{{ calendar_month|default:9 }}');
                let currentYear = parseInt('{{ calendar_year|default:2025 }}');
                
                // Month navigation
                function changeMonth(direction) {
                    currentMonth += direction;
                    if (currentMonth > 11) {
                        currentMonth = 0;
                        currentYear++;
                    } else if (currentMonth < 0) {
                        currentMonth = 11;
                        currentYear--;
                    }
                    
                    // Update calendar via AJAX
                    fetch(`/get-calendar-data/?month=${currentMonth + 1}&year=${currentYear}`)
                        .then(response => response.json())
                        .then(data => {
                            document.getElementById('calendar-month').innerHTML = data.month_name;
                            document.getElementById('calendar-grid').innerHTML = data.calendar_html;
                        })
                        .catch(error => console.error('Error:', error));
                }
                
                // Show day entry
                function showDayEntry(date) {
                    fetch(`/get-day-entry/?date=${date}`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.entry) {
                                // Create and show modal with entry details
                                const modal = document.createElement('div');
                                modal.style.cssText = `
                                    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                                    background: rgba(0,0,0,0.7); z-index: 1000;
                                    display: flex; align-items: center; justify-content: center;
                                    padding: 20px;
                                `;
                                
                                modal.innerHTML = `
                                    <div style="
                                        background: white; border-radius: 15px; padding: 25px;
                                        max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;
                                        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
                                    ">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                            <h3 style="margin: 0; color: #333;">üìÖ ${data.entry.date}</h3>
                                            <button onclick="this.closest('[style*=fixed]').remove()" style="
                                                background: none; border: none; font-size: 24px;
                                                cursor: pointer; color: #666; padding: 5px;
                                            ">√ó</button>
                                        </div>
                                        <div style="color: #333;">
                                            <h4 style="color: #667eea; margin-bottom: 10px;">üéâ ${data.entry.title}</h4>
                                            <p style="margin-bottom: 15px;">${data.entry.description}</p>
                                            ${data.entry.mood_rating ? `<div style="margin-bottom: 10px;"><strong>Mood:</strong> ${data.entry.mood_rating}/10</div>` : ''}
                                            ${data.entry.category ? `<div style="margin-bottom: 10px;"><strong>Category:</strong> ${data.entry.category}</div>` : ''}
                                            <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; font-size: 0.9rem; color: #666;">
                                                Created: ${data.entry.created_at}
                                            </div>
                                        </div>
                                    </div>
                                `;
                                
                                document.body.appendChild(modal);
                                
                                // Close modal when clicking outside
                                modal.addEventListener('click', (e) => {
                                    if (e.target === modal) modal.remove();
                                });
                            }
                        })
                        .catch(error => console.error('Error:', error));
                }
                
                // Sticky Notes Functions
                function createFirstNote(element) {
                    element.focus();
                    element.addEventListener('blur', function() {
                        const content = this.textContent.trim();
                        if (content) {
                            createStickyNote(content, this);
                        }
                    });
                    
                    element.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                }
                
                function createStickyNote(content, element) {
                    fetch('/sticky-notes/create/', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `content=${encodeURIComponent(content)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Replace the placeholder with real note
                            const noteElement = element.closest('.sticky-note');
                            noteElement.setAttribute('data-note-id', data.note.id);
                            noteElement.innerHTML = `
                                <div class="sticky-note-content" contenteditable="true">${data.note.content}</div>
                                <div class="sticky-note-actions">
                                    <button class="complete-btn" title="Complete as win" onclick="completeNote(${data.note.id})">‚úì</button>
                                    <button class="delete-btn" title="Delete note" onclick="deleteNote(${data.note.id})">√ó</button>
                                </div>
                            `;
                            
                            // Add the + button if it doesn't exist
                            if (!document.getElementById('add-note-btn')) {
                                const addButton = document.createElement('button');
                                addButton.id = 'add-note-btn';
                                addButton.className = 'add-note-button';
                                addButton.onclick = addNewNote;
                                addButton.title = 'Add another note';
                                addButton.textContent = '+';
                                document.getElementById('sticky-notes-container').appendChild(addButton);
                            }
                            
                            setupNoteEditing(noteElement);
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
                
                function addNewNote() {
                    const container = document.getElementById('sticky-notes-container');
                    const addBtn = document.getElementById('add-note-btn');
                    
                    // Check if we already have 6 notes (max limit)
                    const existingNotes = container.querySelectorAll('.sticky-note').length;
                    if (existingNotes >= 6) {
                        alert('Maximum 6 notes allowed. Complete or delete some notes to add more!');
                        return;
                    }
                    
                    const newNote = document.createElement('div');
                    newNote.className = 'sticky-note';
                    newNote.setAttribute('data-note-id', 'new');
                    newNote.innerHTML = `
                        <div class="sticky-note-content" contenteditable="true" data-placeholder="Quick note..."></div>
                    `;
                    
                    container.insertBefore(newNote, addBtn);
                    
                    const contentDiv = newNote.querySelector('.sticky-note-content');
                    contentDiv.focus();
                    
                    contentDiv.addEventListener('blur', function() {
                        const content = this.textContent.trim();
                        if (content) {
                            createStickyNote(content, this);
                        } else {
                            newNote.remove();
                        }
                    });
                    
                    contentDiv.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                }
                
                function setupNoteEditing(noteElement) {
                    const contentDiv = noteElement.querySelector('.sticky-note-content');
                    const noteId = noteElement.getAttribute('data-note-id');
                    
                    contentDiv.addEventListener('blur', function() {
                        const content = this.textContent.trim();
                        updateStickyNote(noteId, content);
                    });
                    
                    contentDiv.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            this.blur();
                        }
                    });
                }
                
                function updateStickyNote(noteId, content) {
                    fetch(`/sticky-notes/${noteId}/update/`, {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: `content=${encodeURIComponent(content)}`
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.deleted) {
                            // Note was deleted because content was empty
                            document.querySelector(`[data-note-id="${noteId}"]`).remove();
                        }
                    })
                    .catch(error => console.error('Error:', error));
                }
                
                function completeNote(noteId) {
                    if (confirm('Mark this note as completed and add it to today\'s wins?')) {
                        fetch(`/sticky-notes/${noteId}/complete/`, {
                            method: 'POST',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                // Celebration animation
                                const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                                noteElement.style.transform = 'scale(1.2) rotate(0deg)';
                                noteElement.style.background = '#4caf50';
                                noteElement.style.color = 'white';
                                
                                setTimeout(() => {
                                    noteElement.style.transition = 'all 0.5s ease-out';
                                    noteElement.style.transform = 'scale(0) rotate(180deg)';
                                    noteElement.style.opacity = '0';
                                    
                                    setTimeout(() => {
                                        noteElement.remove();
                                        showCelebration(`üéâ "${data.entry.title}" added to your wins!`);
                                    }, 500);
                                }, 300);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                }
                
                function deleteNote(noteId) {
                    if (confirm('Delete this note?')) {
                        fetch(`/sticky-notes/${noteId}/delete/`, {
                            method: 'DELETE',
                            headers: {
                                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                const noteElement = document.querySelector(`[data-note-id="${noteId}"]`);
                                noteElement.style.transition = 'all 0.3s ease-out';
                                noteElement.style.transform = 'scale(0) rotate(-10deg)';
                                noteElement.style.opacity = '0';
                                
                                setTimeout(() => noteElement.remove(), 300);
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    }
                }
                
                function showCelebration(message) {
                    const celebration = document.createElement('div');
                    celebration.style.cssText = `
                        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                        background: #4caf50; color: white; padding: 20px 30px;
                        border-radius: 10px; font-size: 1.1rem; font-weight: bold;
                        box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 2000;
                        animation: celebrationBounce 0.6s ease-out;
                    `;
                    celebration.textContent = message;
                    document.body.appendChild(celebration);
                    
                    setTimeout(() => celebration.remove(), 3000);
                }
                
                // Initialize existing note editing
                document.addEventListener('DOMContentLoaded', function() {
                    document.querySelectorAll('.sticky-note[data-note-id]:not([data-note-id="new"])').forEach(setupNoteEditing);
                });
            </script>
            
            <style>
                @keyframes celebrationBounce {
                    0% { transform: translate(-50%, -50%) scale(0); }
                    50% { transform: translate(-50%, -50%) scale(1.1); }
                    100% { transform: translate(-50%, -50%) scale(1); }
                }
            </style>
        </div>
    </div>
    
    <!-- Week Navigation Enhanced Styles -->
    <style>
        .week-nav-btn {
            position: relative;
            overflow: hidden;
        }
        
        .week-nav-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .week-nav-btn:hover::before {
            left: 100%;
        }
        
        .week-nav-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }
        
        .week-nav-current:hover {
            box-shadow: 0 8px 25px rgba(40, 167, 69, 0.4);
        }
        
        .week-nav-btn:active {
            transform: translateY(-1px) scale(1.01);
        }
        
        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .week-nav-btn {
                font-size: 0.85rem !important;
                padding: 12px 18px !important;
            }
        }
    </style>

    <!-- Week Navigation -->
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <a href="?week={{ prev_week }}" class="week-nav-btn week-nav-prev" style="
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        ">
            <span style="font-size: 1.1rem;">‚Üê</span>
            <span>Previous Week</span>
        </a>
        
        {% if not is_current_week %}
        <a href="{% url 'weekly_dashboard' %}" class="week-nav-btn week-nav-current" style="
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.3);
            position: relative;
            overflow: hidden;
        ">
            <span style="font-size: 1.1rem;">üè†</span>
            <span>Current Week</span>
        </a>
        {% endif %}
        
        <a href="?week={{ next_week }}" class="week-nav-btn week-nav-next" style="
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 24px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        ">
            <span>Next Week</span>
            <span style="font-size: 1.1rem;">‚Üí</span>
        </a>
    </div>
    
    <!-- Week Grid using Flexbox for guaranteed compatibility -->
    <div style="
        display: flex;
        flex-wrap: wrap;
        gap: 25px;
        margin: 40px 0;
        justify-content: center;
    ">
        {% for day in week_days %}
        <div class="day-card-clickable" 
             data-date="{{ day.date|date:'Y-m-d' }}"
             style="
                background: white;
                border-radius: 20px;
                padding: 25px;
                box-shadow: 0 8px 25px rgba(0,0,0,0.1);
                transition: all 0.3s ease;
                cursor: pointer;
                position: relative;
                overflow: hidden;
                min-height: 280px;
                flex: 1 1 280px;
                max-width: 350px;
                border: 3px solid {% if day.is_today %}#28a745{% elif day.entry.has_content %}#667eea{% else %}transparent{% endif %};
                {% if day.is_today %}
                background: linear-gradient(135deg, #f8fff9 0%, #ffffff 100%);
                {% elif day.entry.has_content %}
                background: linear-gradient(135deg, #fff3e0 0%, #ffffff 100%);
                {% elif day.is_future %}
                opacity: 0.7;
                {% else %}
                opacity: 0.95;
                {% endif %}
             "
             onmouseover="this.style.transform='translateY(-8px) scale(1.02)'; this.style.boxShadow='0 15px 40px rgba(0,0,0,0.15)'"
             onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 8px 25px rgba(0,0,0,0.1)'">
            
            <!-- Gradient Top Border -->
            <div style="
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 6px;
                background: linear-gradient(90deg, #ff6b6b, #ffa726, #66bb6a, #42a5f5, #ab47bc);
            "></div>
            
            <!-- Day Header -->
            <div style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 20px;
                padding-bottom: 15px;
                border-bottom: 2px solid #f8f9fa;
            ">
                <div>
                    <h3 style="margin: 0; font-size: 1.4rem; color: #2c3e50; font-weight: 600;">{{ day.day_name }}</h3>
                    <div style="font-size: 0.9rem; color: #6c757d; margin-top: 5px;">{{ day.date|date:'M j, Y' }}</div>
                </div>
                <div style="font-size: 2.5rem; font-weight: bold; color: #667eea; opacity: 0.3;">{{ day.day_number }}</div>
            </div>
            
            <!-- Status Indicator -->
            <div style="margin-bottom: 15px;">
                {% if day.is_today %}
                    <span style="background: #28a745; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 500;">Today</span>
                {% elif day.is_past %}
                    <span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 500;">Past</span>
                {% else %}
                    <span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: 500;">Future</span>
                {% endif %}
            </div>
            
            <!-- Day Content -->
            <div style="min-height: 120px;">
                {% if day.entry and day.entry.has_content %}
                    <!-- Entry Preview -->
                    <div style="margin-bottom: 15px; position: relative;">
                        <!-- Entry Actions -->
                        <div class="entry-actions" style="position: absolute; top: 0; right: 0; display: flex; gap: 5px; opacity: 0; transition: opacity 0.2s;">
                            <button class="btn btn-sm btn-outline-primary" onclick="loadEntryModal('{{ day.date|date:'Y-m-d' }}')" title="Edit entry">
                                <i class="fas fa-edit" style="font-size: 0.8rem;"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry({{ day.entry.id }})" title="Delete entry">
                                <i class="fas fa-trash" style="font-size: 0.8rem;"></i>
                            </button>
                        </div>
                        
                        {% if day.entry.title %}
                            <div style="font-weight: 600; color: #2c3e50; margin-bottom: 8px; font-size: 1.1rem; padding-right: 60px;">{{ day.entry.title|truncatechars:50 }}</div>
                        {% endif %}
                        
                        {% if day.entry.content %}
                            <div style="color: #6c757d; font-size: 0.95rem; line-height: 1.4; margin-bottom: 10px;">{{ day.entry.content|format_wins_truncate:80 }}</div>
                        {% endif %}
                        
        {% if day.entry.mood_rating %}
            <div style="display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: #f8f9fa; border-radius: 20px; font-size: 0.9rem; color: #495057; margin-bottom: 10px;">
                <span>Mood: {{ day.entry.mood_emoji }}</span>
            </div>
        {% endif %}
        
        {% if day.entry.gratitude_text %}
            <div style="background: #fff8e7; padding: 12px; border-radius: 10px; border-left: 4px solid #ffc107; margin-top: 10px; font-style: italic; color: #856404; font-size: 0.9rem;">
                <strong>Grateful for:</strong> "{{ day.entry.gratitude_text|truncatechars:60 }}"
            </div>
        {% endif %}
                    </div>
                {% else %}
                    <!-- Empty Day -->
                    <div style="text-align: center; color: #adb5bd; font-style: italic; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; gap: 15px;">
                        <div style="font-size: 3rem; opacity: 0.5;">üìù</div>
                        <div style="font-size: 1.1rem;">No entry yet</div>
                        <div style="font-size: 0.9rem; color: #6c757d;">Click to add your daily wins!</div>
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Entry Modal (will be populated via AJAX) -->
<div class="modal fade" id="entryModal" tabindex="-1">
    <div class="modal-dialog modal-lg" style="max-height: 90vh;">
        <div class="modal-content" id="modal-content" style="max-height: 90vh; overflow-y: auto;">
            <!-- Content loaded via AJAX -->
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle day card clicks
    document.querySelectorAll('.day-card-clickable').forEach(card => {
        card.addEventListener('click', function() {
            const date = this.dataset.date;
            loadEntryModal(date);
        });
    });
});

function loadEntryModal(date) {
    // Modal popup for day clicks
    const modalElement = new bootstrap.Modal(document.getElementById('entryModal'));
    
    // Loading spinner while fetching
    document.getElementById('modal-content').innerHTML = `
        <div class="modal-body text-center p-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading your entry...</p>
        </div>
    `;
    modalElement.show();
    
    // Fetch entry data (or create new)
    fetch('/entry/' + date + '/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('modal-content').innerHTML = data.html;
            
            // setup form handling
            initializeModalForm(date);
        })
        .catch(error => {
            console.error('Error loading entry:', error);
            // TODO: better error handling
            document.getElementById('modal-content').innerHTML = `
                <div class="modal-body text-center p-5">
                    <div class="text-danger">
                        <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                        <h5>Error Loading Entry</h5>
                        <p>Please try again later.</p>
                    </div>
                </div>
            `;
        });
}

function initializeModalForm(date) {
    const form = document.getElementById('entry-form');
    if (!form) return;
    
    // Initialize category click handlers
    initializeCategoryHandlers();
    
    // Initialize manage categories button
    const manageCategoriesBtn = document.getElementById('manageCategoriesBtn');
    if (manageCategoriesBtn) {
        console.log('‚úÖ Manage categories button found! Adding event listener...');
        manageCategoriesBtn.addEventListener('click', function() {
            console.log('üî• Manage categories button clicked!');
            openCategoryManager();
        });
    } else {
        console.error('‚ùå Manage categories button not found!');
    }
    
    form.addEventListener('submit', function(e) {
        e.preventDefault(); // AJAX form submission
        
        // Check form values before submitting
        const titleField = form.querySelector('input[name="title"]');
        const contentField = form.querySelector('textarea[name="content"]');
        const gratitudeField = form.querySelector('textarea[name="gratitude_text"]');
        const moodField = form.querySelector('select[name="mood_rating"]');
        const submitButton = form.querySelector('button[type="submit"]');
        
        const title = titleField ? titleField.value.trim() : '';
        const content = contentField ? contentField.value.trim() : '';
        const gratitude = gratitudeField ? gratitudeField.value.trim() : '';
        const mood = moodField ? moodField.value : '';
        
        // Empty form validation
        if (!title && !content && !gratitude && !mood) {
            // Visual feedback for empty form
            if (submitButton) {
                const originalText = submitButton.innerHTML;
                submitButton.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>Please add some content!';
                submitButton.classList.add('btn-warning');
                submitButton.classList.remove('btn-primary');
                
                // Reset button after 3 seconds
                setTimeout(() => {
                    submitButton.innerHTML = originalText;
                    submitButton.classList.remove('btn-warning');
                    submitButton.classList.add('btn-primary');
                }, 3000);
            }
            
            // Also show an alert in the modal
            const existingAlert = form.querySelector('.alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>ü§î Your entry seems to be empty!</strong> Please add at least one of the following: 
                a title, your wins/achievements, a gratitude note, or select your mood.
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // Insert the alert before the submit button container
            const modalFooter = document.querySelector('.modal-footer');
            if (modalFooter) {
                modalFooter.parentNode.insertBefore(alertDiv, modalFooter);
            }
            
            return; // Don't submit the form
        }
        
        // Show saving state
        if (submitButton) {
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
            submitButton.disabled = true;
        }
        
        const formData = new FormData(form);
        
        fetch('/entry/' + date + '/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Close modal and refresh the page to show updated card
                bootstrap.Modal.getInstance(document.getElementById('entryModal')).hide();
                location.reload();
            } else {
                // Show form errors
                console.error('Form errors:', data.errors);
                
                // Remove existing alerts
                const existingAlert = form.querySelector('.alert');
                if (existingAlert) {
                    existingAlert.remove();
                }
                
                // Display server-side validation errors
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show mt-3';
                
                let errorHTML = '<i class="fas fa-exclamation-triangle me-2"></i><strong>Please fix the following:</strong><ul class="mb-0 mt-2">';
                
                for (const [field, errors] of Object.entries(data.errors)) {
                    for (const error of errors) {
                        if (field === '__all__') {
                            errorHTML += `<li>${error}</li>`;
                        } else {
                            errorHTML += `<li><strong>${field.charAt(0).toUpperCase() + field.slice(1)}:</strong> ${error}</li>`;
                        }
                    }
                }
                
                errorHTML += '</ul><button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>';
                alertDiv.innerHTML = errorHTML;
                
                // Insert the alert before the submit button container
                const modalFooter = document.querySelector('.modal-footer');
                if (modalFooter) {
                    modalFooter.parentNode.insertBefore(alertDiv, modalFooter);
                }
                
                // Reset submit button
                if (submitButton) {
                    const isUpdate = submitButton.textContent.includes('Update');
                    submitButton.innerHTML = isUpdate ? 
                        '<i class="fas fa-save me-2"></i>Update Entry' : 
                        '<i class="fas fa-save me-2"></i>Save Entry';
                    submitButton.disabled = false;
                    submitButton.classList.remove('btn-warning');
                    submitButton.classList.add('btn-primary');
                }
            }
        })
        .catch(error => {
            console.error('Error saving entry:', error);
            
            // Reset submit button on error
            if (submitButton) {
                const isUpdate = submitButton.textContent.includes('Update');
                submitButton.innerHTML = isUpdate ? 
                    '<i class="fas fa-save me-2"></i>Update Entry' : 
                    '<i class="fas fa-save me-2"></i>Save Entry';
                submitButton.disabled = false;
            }
            
            alert('Error saving entry. Please try again.');
        });
    });
}

// Initialize category click handlers
function initializeCategoryHandlers() {
    document.querySelectorAll('.category-item').forEach(function(item) {
        item.addEventListener('click', function(e) {
            if (e.target.type !== 'checkbox' && !e.target.matches('label')) {
                const checkbox = this.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = !checkbox.checked;
                    checkbox.dispatchEvent(new Event('change'));
                }
            }
        });
    });
}

// Category Manager Functions
function openCategoryManager() {
    console.log('=== Opening category manager ===');
    
    const modalElement = document.getElementById('categoryManagerModal');
    if (!modalElement) {
        console.error('‚ùå Modal element not found');
        alert('Error: Category manager modal not found in the DOM.');
        return;
    }
    
    loadUserCategories();
    
    const categoryModal = new bootstrap.Modal(modalElement);
    categoryModal.show();
}

function loadUserCategories() {
    console.log('Loading user categories...');
    
    const categoryList = document.getElementById('category-list');
    if (categoryList) {
        categoryList.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading categories...</div>';
    }
    
    fetch('/categories/ajax/list/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayCategories(data.categories);
        } else {
            console.error('Failed to load categories');
            if (categoryList) {
                categoryList.innerHTML = '<div class="text-danger">Failed to load categories</div>';
            }
        }
    })
    .catch(error => {
        console.error('Error loading categories:', error);
        if (categoryList) {
            categoryList.innerHTML = '<div class="text-danger">Error loading categories</div>';
        }
    });
}

function displayCategories(categories) {
    console.log('üìã Displaying categories:', categories);
    const categoryList = document.getElementById('category-list');
    
    if (!categoryList) {
        console.error('‚ùå Category list element not found');
        return;
    }
    
    if (categories.length === 0) {
        categoryList.innerHTML = `
            <div class="text-center text-muted p-4">
                <i class="fas fa-tags fa-2x mb-3 text-secondary"></i>
                <h6>No categories yet!</h6>
                <p class="small">Create your first category using the button below.</p>
            </div>
        `;
        return;
    }
    
    let html = '<div class="list-group list-group-flush">';
    categories.forEach(category => {
        html += `
            <div class="list-group-item d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="category-color-circle me-3" style="background-color: ${category.color}; width: 20px; height: 20px; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 0 1px #dee2e6;"></div>
                    <span class="fw-medium">${category.name}</span>
                </div>
                <div class="btn-group" role="group">
                    <button class="btn btn-outline-warning btn-sm" onclick="editCategory(${category.id})" title="Edit category">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-outline-danger btn-sm" onclick="deleteCategory(${category.id})" title="Delete category">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    categoryList.innerHTML = html;
    console.log('‚úÖ Categories displayed successfully');
}

// Category deletion with confirmation
function deleteCategory(categoryId) {
    if (!confirm('Are you sure you want to delete this category?')) {
        return;
    }
    
    fetch(`/categories/${categoryId}/ajax/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadUserCategories();
            alert('Category deleted successfully!');
        } else {
            alert('Error deleting category: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error deleting category:', error);
        alert('Error deleting category');
    });
}

// Create new category via AJAX
function createCategory() {
    console.log('üé® Creating new category...');
    const nameInput = document.getElementById('categoryName');
    const colorInput = document.getElementById('categoryColor');
    
    // Validate form inputs exist
    if (!nameInput || !colorInput) {
        console.error('‚ùå Category form inputs not found');
        alert('Category form inputs not found');
        return;
    }
    
    const name = nameInput.value.trim();
    const color = colorInput.value;
    
    console.log('üìù Category data:', { name, color });
    
    if (!name) {
        alert('Please enter a category name');
        nameInput.focus();
        return;
    }
    
    // Prepare form data for submission
    const formData = new FormData();
    formData.append('name', name);
    formData.append('color', color);
    formData.append('description', ''); // Empty description since it's optional
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    console.log('üöÄ Sending create request...');
    
    // Submit to server
    fetch('/categories/ajax/create/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        console.log('üì° Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('üì¶ Response data:', data);
        if (data.success) {
            // Clear form and reload categories
            nameInput.value = '';
            colorInput.value = '#007bff';
            loadUserCategories();
            toggleCategoryForm();
            alert('Category created successfully!');
        } else {
            console.error('‚ùå Server error:', data);
            alert('Error creating category: ' + (data.error || JSON.stringify(data.errors)));
        }
    })
    .catch(error => {
        console.error('‚ùå Network error:', error);
        alert('Error creating category: ' + error.message);
    });
}

function toggleCategoryForm() {
    console.log('üéØ toggleCategoryForm() called!');
    const form = document.getElementById('quickCategoryForm');
    const button = document.querySelector('[onclick="toggleCategoryForm()"]');
    
    console.log('Form element:', form);
    console.log('Button element:', button);
    
    if (form && button) {
        const isFormVisible = form.style.display !== 'none' && form.style.display !== '';
        
        if (isFormVisible) {
            form.style.display = 'none';
            button.innerHTML = '<i class="fas fa-plus me-2"></i>Add New Category';
            console.log('‚úÖ Form hidden');
        } else {
            form.style.display = 'block';
            button.innerHTML = '<i class="fas fa-minus me-2"></i>Cancel';
            console.log('‚úÖ Form shown');
            
            // Focus on the name input when showing the form
            const nameInput = document.getElementById('categoryName');
            if (nameInput) {
                setTimeout(() => nameInput.focus(), 100);
            }
        }
    } else {
        console.error('‚ùå Form or button not found');
        console.log('Available elements with onclick="toggleCategoryForm()":');
        console.log(document.querySelectorAll('[onclick="toggleCategoryForm()"]'));
    }
}

function refreshCategoriesInMainForm() {
    fetch('/categories/ajax/list/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const categoriesContainer = document.querySelector('.category-checkboxes-custom');
            if (categoriesContainer) {
                let html = '';
                if (data.categories.length === 0) {
                    html = `
                        <div class="no-categories-message">
                            <i class="fas fa-info-circle text-muted me-2"></i>
                            <span class="text-muted">No categories yet. Click "Manage" to create some!</span>
                        </div>
                    `;
                } else {
                    data.categories.forEach(category => {
                        html += `
                            <div class="category-item">
                                <input 
                                    type="checkbox" 
                                    id="id_categories_${category.id}" 
                                    name="categories" 
                                    value="${category.id}"
                                    class="category-checkbox">
                                <label for="id_categories_${category.id}" class="category-label">
                                    <span class="category-color-dot" style="background-color: ${category.color};"></span>
                                    ${category.name}
                                </label>
                            </div>
                        `;
                    });
                }
                categoriesContainer.innerHTML = html;
                
                // Re-attach click handlers
                initializeCategoryHandlers();
                
                alert('Categories refreshed successfully!');
            }
        } else {
            alert('Error refreshing categories');
        }
    })
    .catch(error => {
        console.error('Error refreshing categories:', error);
        alert('Refresh failed, but endpoint exists! Check console.');
    });
    
    // Close the modal
    const categoryModal = bootstrap.Modal.getInstance(document.getElementById('categoryManagerModal'));
    if (categoryModal) {
        categoryModal.hide();
    }
}

// Edit category functionality
function editCategory(categoryId) {
    console.log('‚úèÔ∏è Editing category:', categoryId);
    
    // First, fetch the current category data
    fetch('/categories/ajax/list/')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const category = data.categories.find(cat => cat.id === categoryId);
            if (category) {
                // Populate the edit form
                showEditCategoryForm(category);
            } else {
                alert('Category not found');
            }
        } else {
            alert('Error loading category data');
        }
    })
    .catch(error => {
        console.error('Error loading category for edit:', error);
        alert('Error loading category data');
    });
}

function showEditCategoryForm(category) {
    // Hide the regular add form if it's showing
    const addForm = document.getElementById('quickCategoryForm');
    if (addForm && addForm.style.display !== 'none') {
        toggleCategoryForm();
    }
    
    // Show/create edit form
    let editForm = document.getElementById('editCategoryForm');
    if (!editForm) {
        // Create edit form if it doesn't exist
        const categoryList = document.getElementById('category-list');
        const editFormHtml = `
            <div class="edit-category-form mb-3" id="editCategoryForm" style="display: none;">
                <div class="card border-warning">
                    <div class="card-body">
                        <h6 class="card-title text-warning">
                            <i class="fas fa-edit me-2"></i>Edit Category
                        </h6>
                        <div class="row g-2">
                            <div class="col-8">
                                <input type="text" class="form-control" id="editCategoryName" placeholder="Enter category name">
                            </div>
                            <div class="col-4">
                                <input type="color" class="form-control form-control-color" id="editCategoryColor" title="Choose color">
                            </div>
                        </div>
                        <div class="mt-3 text-end">
                            <button type="button" class="btn btn-secondary btn-sm me-2" onclick="cancelEditCategory()">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-warning btn-sm" onclick="saveEditCategory()">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                        <input type="hidden" id="editCategoryId">
                    </div>
                </div>
            </div>
        `;
        categoryList.insertAdjacentHTML('beforebegin', editFormHtml);
        editForm = document.getElementById('editCategoryForm');
    }
    
    // Populate the form with current category data
    document.getElementById('editCategoryName').value = category.name;
    document.getElementById('editCategoryColor').value = category.color;
    document.getElementById('editCategoryId').value = category.id;
    
    // Show the edit form
    editForm.style.display = 'block';
    
    // Focus on the name input
    setTimeout(() => document.getElementById('editCategoryName').focus(), 100);
}

function cancelEditCategory() {
    const editForm = document.getElementById('editCategoryForm');
    if (editForm) {
        editForm.style.display = 'none';
    }
}

function saveEditCategory() {
    const nameInput = document.getElementById('editCategoryName');
    const colorInput = document.getElementById('editCategoryColor');
    const idInput = document.getElementById('editCategoryId');
    
    if (!nameInput || !colorInput || !idInput) {
        alert('Edit form inputs not found');
        return;
    }
    
    const name = nameInput.value.trim();
    const color = colorInput.value;
    const categoryId = idInput.value;
    
    if (!name) {
        alert('Please enter a category name');
        nameInput.focus();
        return;
    }
    
    console.log('üíæ Saving category changes:', { id: categoryId, name, color });
    
    const formData = new FormData();
    formData.append('name', name);
    formData.append('color', color);
    formData.append('description', ''); // Empty description since it's optional
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    fetch(`/categories/${categoryId}/edit/`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            console.log('‚úÖ Category updated successfully');
            // Hide edit form and reload categories
            cancelEditCategory();
            loadUserCategories();
            alert('Category updated successfully!');
        } else {
            console.error('‚ùå Error updating category, status:', response.status);
            alert('Error updating category. Please try again.');
        }
    })
    .catch(error => {
        console.error('‚ùå Network error updating category:', error);
        alert('Error updating category. Please check your connection and try again.');
    });
}

// Entry delete functionality
function deleteEntry(entryId) {
    if (!confirm('Are you sure you want to delete this entry? This action cannot be undone.')) {
        return;
    }
    
    console.log('üóëÔ∏è Deleting entry:', entryId);
    
    fetch(`/entries/${entryId}/delete/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            'Content-Type': 'application/x-www-form-urlencoded',
        }
    })
    .then(response => {
        if (response.ok) {
            console.log('‚úÖ Entry deleted successfully');
            // Refresh the page to show updated content
            location.reload();
        } else {
            console.error('‚ùå Error deleting entry, status:', response.status);
            alert('Error deleting entry. Please try again.');
        }
    })
    .catch(error => {
        console.error('‚ùå Network error deleting entry:', error);
        alert('Error deleting entry. Please check your connection and try again.');
    });
}

// Make functions globally available for onclick handlers in dynamically loaded content
window.toggleCategoryForm = toggleCategoryForm;
window.createCategory = createCategory;
window.deleteCategory = deleteCategory;
window.refreshCategoriesInMainForm = refreshCategoriesInMainForm;
window.deleteEntry = deleteEntry;
window.editCategory = editCategory;
window.showEditCategoryForm = showEditCategoryForm;
window.cancelEditCategory = cancelEditCategory;
window.saveEditCategory = saveEditCategory;
</script>

<style>
/* Mobile responsive */
@media (max-width: 768px) {
    .week-container {
        padding: 10px;
    }
    
    .week-container h1 {
        font-size: 2rem !important;
    }
}

/* Entry actions hover effect */
.day-card:hover .entry-actions {
    opacity: 1 !important;
}

.entry-actions .btn {
    background-color: rgba(255, 255, 255, 0.95);
    border-color: rgba(0, 0, 0, 0.1);
    backdrop-filter: blur(5px);
}

.entry-actions .btn:hover {
    transform: scale(1.1);
    transition: transform 0.1s ease;
}

/* Rainbow gradient animation for header */
@keyframes gradient-shift {
    0%, 100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
}
</style>

{% endblock %}
